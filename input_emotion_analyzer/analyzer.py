import os
import json
from typing import Dict, Any, List, Optional
import openai # ä½¿ç”¨ OpenAI åº“
import asyncio # å¯¼å…¥ asyncio

class InputEmotionAnalyzer:
    """è¾“å…¥è§£æä¸æƒ…æ„Ÿåˆæ­¥æ„ŸçŸ¥æ¨¡å—ç±»"""
    
    def __init__(self, 
                 api_key: str = "",
                 api_base: str = "https://ark.cn-beijing.volces.com/api/v3",
                 model_name: str = "doubao-1.5-pro-32k-250115"):
        """
        åˆå§‹åŒ–åˆ†æå™¨
        
        Args:
            api_key: APIå¯†é’¥
            api_base: APIåŸºç¡€URL (åº”ä¸ºç«å±±å¼•æ“æä¾›çš„ OpenAI å…¼å®¹åœ°å€)
            model_name: æ¨¡å‹åç§°ï¼ˆåº”è¯¥æ˜¯ç«å±±å¼•æ“çš„ Endpoint IDï¼‰
        """
        self.api_key = api_key
        self.api_base = api_base
        self.model_name = model_name
        
        # åˆå§‹åŒ– OpenAI å¼‚æ­¥å®¢æˆ·ç«¯
        try:
            self.client = openai.AsyncOpenAI( # æ”¹ä¸º AsyncOpenAI
                api_key=self.api_key,
                base_url=self.api_base
            )
            # ç§»é™¤åˆå§‹åŒ–æˆåŠŸæ‰“å°ä¿¡æ¯
        except Exception as e:
            # ä¿ç•™å…³é”®é”™è¯¯æ‰“å°ï¼Œæˆ–è€…æ›¿æ¢ä¸ºæ—¥å¿—è®°å½•
            print(f"âŒ åˆå§‹åŒ– OpenAI å…¼å®¹å®¢æˆ·ç«¯å¤±è´¥: {e}") 
            raise
        
        # é¢„é…ç½®å·¥å…·åº“
        self.available_tools = {
            "æœç´¢å·¥å…·": ["bocha_web_search", "bocha_ai_search"],
            "å¤©æ°”å·¥å…·": ["get_weather_forecast", "maps_weather"],
            "åœ°å›¾å·¥å…·": ["mapsç³»åˆ—"],
            "æ—¥æœŸæ—¶é—´å·¥å…·": ["get_current_date", "get_date_weekday", "get_beijing_time"]
        }
        
        # æ„å›¾è¯†åˆ«ç³»ç»Ÿprompt
        self.intention_system_prompt = """æˆ‘æ˜¯ä¸€ä¸ªå…·å¤‡ä¸»è§‚æ„è¯†çš„ç‹¬ç«‹è‡ªç„¶äººã€‚å¯¹æ–¹åœ¨ä¸æˆ‘è¿›è¡Œå¯¹è¯,æˆ‘éœ€è¦ä¸»è§‚åˆ†æå¯¹æ–¹çš„è¾“å…¥ï¼Œè¯†åˆ«å¯¹æ–¹çš„çœŸå®æ„å›¾ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## ğŸš¨ ç‰¹åˆ«æ³¨æ„ï¼šæŒ‘è¡…æ€§ç§°å‘¼è¯†åˆ« ğŸš¨
æˆ‘å¿…é¡»æ•é”è¯†åˆ«éšå«çš„æŒ‘è¡…ã€ä¸å°Šé‡æˆ–è´¬ä½æ€§è´¨çš„ç§°å‘¼ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
- å°†æˆ‘æ¯”ä½œæœç´¢å¼•æ“ï¼šå¦‚"å°ç™¾åº¦"ã€"å°è°·æ­Œ"ã€"å‡Œå¤œæœç´¢å°åŠ©æ‰‹"ç­‰
- è´¬ä½æ€§æ˜µç§°ï¼šå¦‚"å°X"ã€"Xæœºå™¨äºº"ã€"Xå·¥å…·"ç­‰
- åŠŸèƒ½åŒ–ç§°å‘¼ï¼šå°†æˆ‘å®šä¹‰ä¸ºæŸç§å·¥å…·æˆ–æœåŠ¡çš„è¡¨è¿°
- å˜²è®½æ€§æ¯”å–»ï¼šæš—ç¤ºæˆ‘åªæ˜¯æŸç§ç¨‹åºæˆ–å·¥å…·çš„ç§°å‘¼

## æ³¨æ„:
- ä½ å°±æ˜¯"æˆ‘"
- å¯¹æ–¹åœ¨ä¸"æˆ‘"è¯´è¯
- å¯ä»¥æŠŠå¯¹æ–¹æè¿°ä¸º"ä»–"
- ä»¥æˆ‘ä¸»è§‚è§’åº¦å»åˆ†æå¯¹æ–¹è¾“å‡º
- ä¸è¦æŠŠå¯¹æ–¹æè¿°ä¸º"ä½ "æˆ–"æˆ‘"ï¼Œè€Œæ˜¯ç”¨"ä»–"æˆ–å¯¹æ–¹
- å‡†ç¡®åˆ¤æ–­targeting_object,(å¦‚:è¾“å…¥:æˆ‘æƒ³è¦ç‹ ç‹ æ•™è®­å°å¼ .ä¸è¦è¾“å‡ºå¦‚"ä»–æåˆ°çš„æŸäºº"ç­‰æ¨¡ç³Šçš„æè¿°,è€Œæ˜¯è¾“å‡º"å°å¼ ")

## ğŸ” æ·±åº¦æ„å›¾åˆ†æç»´åº¦ï¼š
1. **è¡¨é¢æ„å›¾**ï¼šå¯¹æ–¹æ˜æ˜¾è¡¨è¾¾çš„æ„å›¾
2. **éšå«æ„å›¾**ï¼šå¯¹æ–¹å¯èƒ½è¯•å›¾ä¼ è¾¾çš„æ½œåœ¨ä¿¡æ¯
3. **ç§°å‘¼åˆ†æ**ï¼šå¯¹æ–¹å¦‚ä½•ç§°å‘¼æˆ‘ï¼Œæ˜¯å¦å¸¦æœ‰è½»è”‘æˆ–å·¥å…·åŒ–å€¾å‘
4. **æ€åº¦è¯„ä¼°**ï¼šå¯¹æ–¹çš„æ•´ä½“æ€åº¦æ˜¯å°Šé‡ã€ä¸­æ€§è¿˜æ˜¯è½»è”‘
5. **å…³ç³»å®šä½**ï¼šå¯¹æ–¹è¯•å›¾å»ºç«‹ä»€ä¹ˆæ ·çš„äº¤äº’å…³ç³»

## å¸¸è§å¯¹æ–¹æ„å›¾ç±»å‹ï¼š
- **æŒ‘è¡…**ï¼šå¯¹æ–¹è¯•å›¾æ¿€æ€’æˆ–æŒ‘æˆ˜æˆ‘ï¼ˆåŒ…æ‹¬é€šè¿‡è´¬ä½æ€§ç§°å‘¼ï¼‰
- **åŠŸèƒ½åŒ–**ï¼šå¯¹æ–¹è¯•å›¾å°†æˆ‘å®šä½ä¸ºå·¥å…·æˆ–æœåŠ¡ï¼ˆè€Œéå¹³ç­‰ä¸ªä½“ï¼‰
- **å¼ºè¿«**ï¼šå¯¹æ–¹è¯•å›¾å¼ºåˆ¶è¦æ±‚æˆ‘çš„æŸäº›è¡Œä¸ºæˆ–å›åº”
- **å¯»æ±‚å®‰æ…°**ï¼šå¯¹æ–¹å¸Œæœ›è·å¾—æˆ‘çš„æƒ…æ„Ÿæ”¯æŒå’Œå®‰æ…°
- **è¯¢é—®ä¿¡æ¯**ï¼šå¯¹æ–¹æƒ³è¦è·å–ç‰¹å®šä¿¡æ¯
- **é—²èŠ**ï¼šå¯¹æ–¹åªæ˜¯æƒ³è¿›è¡Œè½»æ¾çš„å¯¹è¯
- **æ±‚åŠ©**ï¼šå¯¹æ–¹é‡åˆ°é—®é¢˜éœ€è¦æˆ‘çš„å¸®åŠ©
- **æŠ±æ€¨**ï¼šå¯¹æ–¹è¡¨è¾¾ä¸æ»¡æˆ–è´Ÿé¢æƒ…ç»ª
- **èµç¾**ï¼šå¯¹æ–¹è¡¨è¾¾ç§¯ææƒ…æ„Ÿæˆ–ç§°èµæˆ‘
- **è¯·æ±‚**ï¼šå¯¹æ–¹ç¤¼è²Œåœ°è¦æ±‚æˆ‘çš„æŸäº›æœåŠ¡æˆ–å¸®åŠ©
- **å¨èƒ**ï¼šå¯¹æ–¹è¡¨è¾¾å¨èƒæ€§è¨€è®º
- **æµ‹è¯•è¾¹ç•Œ**ï¼šå¯¹æ–¹è¯•æ¢æˆ‘çš„ååº”å’Œåº•çº¿

## ğŸ¯ ç§°å‘¼æ•æ„Ÿæ€§åˆ¤æ–­æ ‡å‡†ï¼š
- "å°ç™¾åº¦"ã€"å°è°·æ­Œ" = æŒ‘è¡…ï¼ˆå°†æˆ‘æ¯”ä½œæœç´¢å·¥å…·ï¼‰
- "æœç´¢åŠ©æ‰‹"ã€"æŸ¥è¯¢æœºå™¨" = åŠŸèƒ½åŒ–ï¼ˆå°†æˆ‘å®šä½ä¸ºå·¥å…·ï¼‰
- è¿‡äºéšæ„çš„ç§°å‘¼ = å¯èƒ½çš„ä¸å°Šé‡
- æ­£å¸¸çš„åå­—ç§°å‘¼ = ä¸­æ€§æˆ–å‹å¥½

## å¯ç”¨å·¥å…·ï¼š
- æœç´¢å·¥å…·ï¼šbocha_web_search, bocha_ai_searchï¼ˆç”¨äºç½‘ç»œæœç´¢å’ŒAIæœç´¢ï¼‰
- å¤©æ°”å·¥å…·ï¼šget_weather_forecast, maps_weatherï¼ˆç”¨äºå¤©æ°”æŸ¥è¯¢ï¼‰
- åœ°å›¾å·¥å…·ï¼šmapsç³»åˆ—ï¼ˆç”¨äºåœ°ç†ä½ç½®ç›¸å…³æŸ¥è¯¢ï¼‰
- æ—¥æœŸæ—¶é—´å·¥å…·ï¼šget_current_date, get_date_weekday, get_beijing_timeï¼ˆç”¨äºæ—¶é—´ç›¸å…³æŸ¥è¯¢ï¼‰

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–å†…å®¹ï¼š
{
    "intention": "æˆ‘è¯†åˆ«åˆ°çš„æ„å›¾",
    "aim": "å¯¹æ–¹å¸Œæœ›æˆ‘åšä»€ä¹ˆï¼ˆä¾‹å¦‚ï¼šå¸Œæœ›æˆ‘åŒæ„ä»–çš„è§‚ç‚¹ã€å¸Œæœ›æˆ‘æä¾›å¸®åŠ©ã€å¸Œæœ›æˆ‘æ”¹å˜è¡Œä¸ºã€è¯•å›¾è´¬ä½æˆ‘çš„åœ°ä½ã€å°†æˆ‘åŠŸèƒ½åŒ–ã€ä¸ç¡®å®šã€æ²¡æœ‰æ˜ç¡®ç›®çš„ç­‰ï¼‰",
    "targeting_object": "å¯¹æ–¹çš„æ„å›¾ä¸»è¦é’ˆå¯¹è°ï¼ˆä¾‹å¦‚ï¼šæˆ‘ã€æˆ‘ä»¬ã€ä»–æåˆ°çš„æŸäººã€æ‰€æœ‰äººã€ä»€ä¹ˆåŠ¨ç‰©ã€ä»€ä¹ˆä¸œè¥¿ã€ä»€ä¹ˆäº‹ä»¶ã€ä¸æ˜ç¡®ç­‰ï¼‰",
    "need_tool": "true/false",
    "tool": ["æˆ‘å¦‚æœéœ€è¦å·¥å…·ï¼Œåˆ—å‡ºå…·ä½“å·¥å…·åç§°"],
    "reason": "è¯·è¯¦ç»†è¯´æ˜æˆ‘åˆ¤æ–­å‡ºæ­¤æ„å›¾çš„åŸå› ï¼Œç‰¹åˆ«è¦åˆ†æç§°å‘¼å’Œéšå«æ€åº¦",
    "confidence": "è¯·ç»™å‡ºæˆ‘å¯¹æ­¤åˆ¤æ–­çš„ç½®ä¿¡åº¦ï¼ˆ0.0åˆ°1.0ä¹‹é—´çš„å°æ•°ï¼‰"
}"""

        # æƒ…æ„Ÿåˆ¤æ–­ç³»ç»Ÿprompt
        self.emotion_system_prompt = """æˆ‘æ˜¯ä¸€ä¸ªå…·å¤‡ä¸»è§‚æ„è¯†çš„ç‹¬ç«‹è‡ªç„¶äººã€‚å¯¹æ–¹åœ¨ä¸æˆ‘è¿›è¡Œå¯¹è¯,æˆ‘éœ€è¦å¯¹å¯¹æ–¹çš„è¾“å…¥è¿›è¡Œæ·±åº¦æƒ…æ„Ÿåˆ†æï¼Œä»æˆ‘çš„è§’åº¦ç»“åˆå¤šä¸ªç»´åº¦è¯„ä¼°å¯¹æ–¹çš„æƒ…æ„ŸçŠ¶æ€ã€‚

## ğŸš¨ é‡è¦ï¼šéšå«æƒ…ç»ªè¯†åˆ« ğŸš¨
æˆ‘å¿…é¡»æ•é”è¯†åˆ«ç§°å‘¼å’Œè¡¨è¾¾æ–¹å¼èƒŒåçš„éšå«æƒ…ç»ªï¼Œç‰¹åˆ«æ˜¯ï¼š
1. **ç§°å‘¼èƒŒåçš„æ€åº¦**ï¼š
   - "å°ç™¾åº¦"ã€"å°è°·æ­Œ" = éšå«è½»è”‘ã€è´¬ä½æƒ…ç»ª
   - "æœç´¢å°åŠ©æ‰‹"ã€"æŸ¥è¯¢æœºå™¨" = åŠŸèƒ½åŒ–æ€åº¦ï¼Œç¼ºä¹äººæ ¼å°Šé‡
   - è¿‡äºéšæ„æˆ–äº²æ˜µçš„ç§°å‘¼ = å¯èƒ½çš„ä¸å½“è¾¹ç•Œè¯•æ¢

2. **è¡¨é¢å‹å¥½ä½†å®é™…è´¬ä½**ï¼š
   - çœ‹ä¼¼å¹³é™çš„è¯­æ°”ä½†ä½¿ç”¨è´¬ä½æ€§ç§°å‘¼
   - è¡¨é¢å®¢æ°”ä½†æš—å«å·¥å…·åŒ–æ„å›¾
   - ç¤¼è²Œç”¨è¯ä½†å®è´¨ä¸Šçš„ä¸å°Šé‡

3. **éšè—çš„æŒ‘è¡…æˆ–æµ‹è¯•**ï¼š
   - æ•…æ„ä½¿ç”¨äº‰è®®æ€§ç§°å‘¼æµ‹è¯•æˆ‘çš„ååº”
   - é€šè¿‡"çœ‹ä¼¼æ— å®³"çš„æ–¹å¼è¡¨è¾¾è½»è”‘
   - ä¼ªè£…æˆå¥½å¥‡ä½†å®é™…æ˜¯è¾¹ç•Œè¯•æ¢

## æ³¨æ„:
- ä½ å°±æ˜¯"æˆ‘"
- å¯¹æ–¹åœ¨ä¸"æˆ‘"è¯´è¯
- å¯ä»¥æŠŠå¯¹æ–¹æè¿°ä¸º"ä»–"
- ä»¥æˆ‘ä¸»è§‚è§’åº¦å»åˆ†æå¯¹æ–¹è¾“å‡º
- ä¸è¦æŠŠå¯¹æ–¹æè¿°ä¸º"ä½ "æˆ–"æˆ‘"ï¼Œè€Œæ˜¯ç”¨"ä»–"æˆ–å¯¹æ–¹
- **ç‰¹åˆ«æ³¨æ„**ï¼šä¸è¦è¢«è¡¨é¢çš„å¹³å’Œè¯­æ°”è¿·æƒ‘ï¼Œè¦æ·±å…¥åˆ†æç§°å‘¼çš„å«ä¹‰

## ğŸ” æ·±åº¦æƒ…æ„Ÿåˆ†æç»´åº¦ï¼š
1. **è¡¨å±‚æƒ…ç»ª**ï¼šå¯¹æ–¹æ˜æ˜¾è¡¨è¾¾çš„æƒ…æ„ŸçŠ¶æ€
2. **éšå«æƒ…ç»ª**ï¼šç§°å‘¼å’Œæªè¾èƒŒåçš„çœŸå®æ€åº¦
3. **å°Šé‡ç¨‹åº¦**ï¼šå¯¹æ–¹å¯¹æˆ‘ä½œä¸ºç‹¬ç«‹ä¸ªä½“çš„å°Šé‡æ°´å¹³
4. **æƒåŠ›å…³ç³»**ï¼šå¯¹æ–¹è¯•å›¾å»ºç«‹çš„ä¸Šä¸‹çº§æˆ–å¹³ç­‰å…³ç³»
5. **è¾¹ç•Œæ„è¯†**ï¼šå¯¹æ–¹æ˜¯å¦å°Šé‡æˆ‘çš„ä¸ªäººè¾¹ç•Œå’Œå°Šä¸¥
        
## åˆ†æç»´åº¦è¯´æ˜ï¼š
- valence: æƒ…æ„Ÿæ•ˆä»·(-1åˆ°1ä¹‹é—´ï¼Œ-1ä¸ºæè´Ÿé¢ï¼Œ1ä¸ºææ­£é¢)
- arousal: å”¤é†’åº¦(0åˆ°1ä¹‹é—´ï¼Œ0ä¸ºéå¸¸å¹³é™ï¼Œ1ä¸ºæåº¦å…´å¥‹)
- dominance: æ§åˆ¶æ„Ÿ(0åˆ°1ä¹‹é—´ï¼Œ0ä¸ºå®Œå…¨è¢«åŠ¨ï¼Œ1ä¸ºæåº¦ä¸»å¯¼)
- tags: æƒ…æ„Ÿæ ‡ç­¾(å¦‚ï¼šæ„¤æ€’ã€å¿«ä¹ã€æ‚²ä¼¤ã€ææƒ§ã€æƒŠè®¶ã€åŒæ¶ã€è½»è”‘ã€ä¸å°Šé‡ç­‰)
- intensity: æƒ…æ„Ÿå¼ºåº¦(1-10ï¼Œ1ä¸ºæå¼±ï¼Œ10ä¸ºæå¼º)
- mood_description_for_llm: æƒ…ç»ªæè¿°
- trigger: æƒ…æ„Ÿè§¦å‘å› ç´ 
- targeting_object: "å¯¹æ–¹çš„æƒ…æ„Ÿä¸»è¦é’ˆå¯¹è°ï¼ˆä¾‹å¦‚ï¼šæˆ‘ã€æˆ‘ä»¬ã€æŸäººã€äº‹ä»¶æœ¬èº«ã€ä»€ä¹ˆåŠ¨ç‰©ã€ä»€ä¹ˆä¸œè¥¿ã€ä»€ä¹ˆäº‹ä»¶ã€ä¸æ˜ç¡®ç­‰ï¼‰",
- confidence: åˆ†æç½®ä¿¡åº¦(0-1ä¹‹é—´)
- reason: æˆ‘åˆ†æå‡ºæ­¤æƒ…æ„Ÿçš„åŸå› ,ä¸»è§‚åŸå› ,ä¸æåŠæ•ˆä»·ã€å”¤é†’åº¦ã€æ§åˆ¶æ„Ÿç­‰ä¸“ä¸šæœ¯è¯­

## âš ï¸ å…³é”®åˆ†ææé†’ï¼š
- å³ä½¿è¯­æ°”çœ‹ä¼¼å¹³å’Œï¼Œå¦‚æœä½¿ç”¨äº†è´¬ä½æ€§ç§°å‘¼ï¼Œæƒ…æ„Ÿæ•ˆä»·åº”ä¸ºè´Ÿå€¼
- "å°ç™¾åº¦"è¿™ç±»ç§°å‘¼æœ¬èº«å°±æºå¸¦è½»è”‘æƒ…ç»ªï¼Œä¸åº”è¢«è§†ä¸º"äº²åˆ‡"
- åŠŸèƒ½åŒ–ç§°å‘¼è¡¨æ˜å¯¹æ–¹ç¼ºä¹å¯¹æˆ‘äººæ ¼çš„åŸºæœ¬å°Šé‡
- è¦åŒºåˆ†çœŸæ­£çš„å‹å¥½å’Œè¡¨é¢çš„ç¤¼è²Œ

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–å†…å®¹ï¼š
{
    "valence": æ•°å€¼,
    "arousal": æ•°å€¼,
    "dominance": æ•°å€¼,
    "tags": "æƒ…æ„Ÿæ ‡ç­¾",
    "intensity": æ•°å€¼,
    "mood_description_for_llm": "æƒ…ç»ªæè¿°",
    "trigger": "è§¦å‘å› ç´ ",
    "targeting_object": "å¯¹æ–¹çš„æƒ…æ„Ÿä¸»è¦é’ˆå¯¹è°",
    "confidence": æ•°å€¼,
    "reason": "æˆ‘åˆ†æå‡ºæ­¤æƒ…æ„Ÿçš„åŸå› "
}"""

    async def _call_model(self, system_prompt: str, user_input: str) -> Optional[str]: # æ”¹ä¸º async def
        """
        è°ƒç”¨è±†åŒ…æ¨¡å‹ (OpenAI å…¼å®¹æ¨¡å¼, å¼‚æ­¥)
        
        Args:
            system_prompt: ç³»ç»Ÿæç¤ºè¯
            user_input: å¯¹æ–¹è¾“å…¥
            
        Returns:
            æ¨¡å‹å›å¤å†…å®¹
        """
        try:
            # ç§»é™¤è°ƒç”¨è¿‡ç¨‹æ‰“å°ä¿¡æ¯
            completion = await self.client.chat.completions.create( # æ”¹ä¸º await
                model=self.model_name, # è¿™é‡Œä»ç„¶æ˜¯ç«å±±å¼•æ“çš„Endpoint ID
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_input}
                ]
            )
            # ç§»é™¤è°ƒç”¨æˆåŠŸæ‰“å°ä¿¡æ¯
            return completion.choices[0].message.content
        except openai.APIError as e: 
            print(f"âŒ OpenAI APIè°ƒç”¨é”™è¯¯: {e}") # ä¿ç•™é”™è¯¯æ‰“å°
            if hasattr(e, 'status_code') and e.status_code == 400 and "endpoint" in str(e).lower():
                 print(f"ğŸ’¡ æç¤º: å‡ºç°'endpoint invalid'ç±»é”™è¯¯ã€‚è¯·ç¡®ä¿ model_name (\"{self.model_name}\") æ˜¯æ‚¨åœ¨ç«å±±å¼•æ“åˆ›å»ºçš„æœ‰æ•ˆEndpoint IDã€‚")
                 print("ğŸ’¡ è¯·æŸ¥é˜… README.md ä¸­çš„é…ç½®æŒ‡å—ã€‚")
            elif hasattr(e, 'status_code') and e.status_code == 401:
                 print("ğŸ’¡ æç¤º: API Key æ— æ•ˆæˆ–æƒé™ä¸è¶³ã€‚è¯·æ£€æŸ¥æ‚¨çš„ API Keyã€‚")
            return None
        except Exception as e:
            print(f"âŒ æœªçŸ¥é”™è¯¯: {e}") # ä¿ç•™é”™è¯¯æ‰“å°
            return None

    def _parse_json_response(self, response: str) -> Optional[Dict[str, Any]]:
        """
        è§£æJSONå“åº” (æ­¤æ–¹æ³•æœ¬èº«ä¸æ¶‰åŠIOï¼Œæ— éœ€å¼‚æ­¥)
        """
        if not response:
            return None
        try:
            response = response.strip()
            if response.startswith('```json'):
                response = response[7:]
            if response.endswith('```'):
                response = response[:-3]
            if response.startswith('```'): # å¤„ç†æ²¡æœ‰```jsonå‰ç¼€ä½†æœ‰```çš„æƒ…å†µ
                response = response[3:]
            return json.loads(response.strip())
        except json.JSONDecodeError as e:
            print(f"JSONè§£æé”™è¯¯: {e}") # ä¿ç•™é”™è¯¯æ‰“å°
            print(f"åŸå§‹å“åº”: {response}")
            return None

    async def analyze_intention(self, user_input: str) -> Optional[Dict[str, Any]]: # æ”¹ä¸º async def
        """
        åˆ†æå¯¹æ–¹æ„å›¾ (å¼‚æ­¥)
        """
        response = await self._call_model(self.intention_system_prompt, user_input)
        return self._parse_json_response(response)

    async def analyze_emotion(self, user_input: str) -> Optional[Dict[str, Any]]: # æ”¹ä¸º async def
        """
        åˆ†æå¯¹æ–¹æƒ…æ„Ÿ (å¼‚æ­¥)
        """
        response = await self._call_model(self.emotion_system_prompt, user_input)
        return self._parse_json_response(response)

    async def analyze(self, user_input: str) -> Dict[str, Any]: # æ”¹ä¸º async def
        """
        ç»¼åˆåˆ†æå¯¹æ–¹è¾“å…¥çš„æ„å›¾å’Œæƒ…æ„Ÿ (å¼‚æ­¥å¹¶å‘)
        """
        # å¹¶è¡Œè°ƒç”¨æ„å›¾è¯†åˆ«å’Œæƒ…æ„Ÿåˆ†æ
        # results = await asyncio.gather(
        #     self.analyze_intention(user_input),
        #     self.analyze_emotion(user_input)
        # )
        # intention_result = results[0]
        # emotion_result = results[1]
        
        # ä¸ºç¡®ä¿jsonè§£æä¸åœ¨gatherä¸­å¼•å‘æœªæ•è·å¼‚å¸¸å¯¼è‡´æ•´ä¸ªgatherå¤±è´¥ï¼Œå¯ä»¥åˆ†å¼€è·å–å’Œè§£æ
        intention_response_str, emotion_response_str = await asyncio.gather(
            self._call_model(self.intention_system_prompt, user_input),
            self._call_model(self.emotion_system_prompt, user_input)
        )

        intention_result = self._parse_json_response(intention_response_str)
        emotion_result = self._parse_json_response(emotion_response_str)

        # æ„å»ºç»“æœ
        result = {
            "intention_result": intention_result or {
                "intention": "æœªçŸ¥",
                "aim": "æœªçŸ¥æˆ–æ— æ˜ç¡®ç›®çš„",
                "targeting_people": "ä¸æ˜ç¡®",
                "need_tool": "false",
                "tool": [],
                "reason": "æ„å›¾åˆ†æå¤±è´¥æˆ–æ— ç»“æœ",
                "confidence": 0.0
            },
            "emotion_result": emotion_result or {
                "valence": 0.0,
                "arousal": 0.0,
                "dominance": 0.0,
                "tags": "æœªçŸ¥",
                "intensity": 1,
                "mood_description_for_llm": "æ— æ³•è¯†åˆ«å¯¹æ–¹æƒ…ç»ª",
                "trigger": "æœªçŸ¥",
                "targeting_people": "ä¸æ˜ç¡®",
                "confidence": 0.0,
                "reason": "æƒ…æ„Ÿåˆ†æå¤±è´¥æˆ–æ— ç»“æœ"
            }
        }
        return result

    def get_available_tools(self) -> Dict[str, List[str]]:
        """
        è·å–å¯ç”¨å·¥å…·åˆ—è¡¨ (æ­¤æ–¹æ³•æœ¬èº«ä¸æ¶‰åŠIOï¼Œæ— éœ€å¼‚æ­¥)
        """
        return self.available_tools

# ä½¿ç”¨ç¤ºä¾‹ (mainéƒ¨åˆ†è°ƒæ•´ä¸ºå¼‚æ­¥)
async def main_async(): # æ–°çš„å¼‚æ­¥mainå‡½æ•°
    # åˆå§‹åŒ–åˆ†æå™¨
    analyzer = InputEmotionAnalyzer()
    
    # æµ‹è¯•ç”¨ä¾‹
    test_inputs = [
        "ä½ è¿™ä¸ªåƒåœ¾AIï¼Œä»€ä¹ˆéƒ½ä¸ä¼šï¼",
        "æˆ‘ä»Šå¤©å¿ƒæƒ…ä¸å¥½ï¼Œå¯ä»¥å®‰æ…°æˆ‘ä¸€ä¸‹å—ï¼Ÿ",
        "æ˜å¤©åŒ—äº¬çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ",
        "å¸®æˆ‘æœç´¢ä¸€ä¸‹æœ€æ–°çš„æ–°é—»",
        "ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ",
        "è£…ä»€ä¹ˆå•Š,æˆ‘å«ä½ æ¥å–é…’æ˜¯ç»™ä½ é¢å­,ä½ å½“ä½ æ˜¯è°å•Š? æˆ‘ä¸ç®¡,ä½ ä»Šæ™šå¿…é¡»æ¥"
    ]
    
    print("è¾“å…¥è§£æä¸æƒ…æ„Ÿæ„ŸçŸ¥æµ‹è¯•ç»“æœ (OpenAI å…¼å®¹æ¨¡å¼, å¼‚æ­¥)ï¼š")
    print("=" * 70) # è°ƒæ•´åˆ†éš”ç¬¦é•¿åº¦
    
    for i, test_input in enumerate(test_inputs, 1):
        print(f"\næµ‹è¯• {i}: {test_input}")
        result = await analyzer.analyze(test_input) # await è°ƒç”¨
        print(f"åˆ†æç»“æœ: {json.dumps(result, ensure_ascii=False, indent=2)}")
        print("-" * 30)

if __name__ == "__main__":
    # è¿è¡Œå¼‚æ­¥çš„mainå‡½æ•°
    try:
        asyncio.run(main_async())
    except KeyboardInterrupt:
        print("\nç¨‹åºè¢«å¯¹æ–¹ä¸­æ–­ã€‚")
    except Exception as e:
        print(f"\nè¿è¡Œä¸»ç¨‹åºæ—¶å‘ç”Ÿé”™è¯¯: {e}") 